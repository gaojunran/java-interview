---
title: 049 	è¯´è¯´ Spring å¯åŠ¨è¿‡ç¨‹ï¼Ÿ
---

Spring çš„å¯åŠ¨è¿‡ç¨‹å¯ä»¥ä»ä¸¤ä¸ªè§’åº¦æ¥çœ‹ï¼š

---

## ä¸€ã€ç”¨æˆ·è§†è§’ï¼ˆåŸºäº Spring Bootï¼‰

å½“æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ª Spring Boot åº”ç”¨ï¼ˆå¸¦ `@SpringBootApplication`ï¼‰æ—¶ï¼Œé€šå¸¸çš„å…¥å£æ˜¯ï¼š

```java
public static void main(String[] args) {
    SpringApplication.run(MyApplication.class, args);
}
```

æ•´ä¸ªæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š

---

### ğŸ§­ 1. åˆ›å»º SpringApplication å¯¹è±¡

```java
SpringApplication app = new SpringApplication(MyApplication.class);
```

* åˆ†æä¸»ç±»ä¸Šçš„æ³¨è§£ï¼ˆæ¯”å¦‚ `@SpringBootApplication`ï¼‰
* æ¨æ–­å½“å‰åº”ç”¨æ˜¯ Web ç±»å‹ã€Reactive è¿˜æ˜¯æ™®é€šåº”ç”¨
* åŠ è½½ç±»è·¯å¾„ä¸­çš„ `META-INF/spring.factories`ï¼ˆå¦‚è‡ªåŠ¨é…ç½®ç±»ï¼‰

---

### ğŸ§° 2. è°ƒç”¨ `run()` æ–¹æ³•

```java
ConfigurableApplicationContext context = app.run(args);
```

æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š

#### 2.1 å‡†å¤‡é˜¶æ®µï¼ˆ`prepareEnvironment()`ï¼‰

* åˆ›å»ºå¹¶é…ç½® `Environment`ï¼ˆæ¯”å¦‚åŠ è½½ `application.properties/yml`ï¼‰
* åŠ è½½ç›‘å¬å™¨å¹¶å¹¿æ’­ ApplicationStartingEventã€EnvironmentPreparedEvent
* åˆ›å»º `ApplicationContext`ï¼ˆé»˜è®¤æ˜¯ `AnnotationConfigServletWebServerApplicationContext`ï¼‰

#### 2.2 åŠ è½½é˜¶æ®µï¼ˆ`prepareContext()`ï¼‰

* è®¾ç½® `ApplicationContext` çš„ Environment
* è®¾ç½® BeanNameGenerator ç­‰è‡ªå®šä¹‰å™¨
* æ³¨å†Œä¸»é…ç½®ç±»ï¼ˆå¸¦ `@SpringBootApplication` çš„ç±»ï¼‰
* è°ƒç”¨ `postProcessApplicationContext()` æ–¹æ³•ï¼ˆå…è®¸ä¿®æ”¹ Contextï¼‰
* è°ƒç”¨ `ApplicationContextInitializer`ï¼ˆå¯æ‰©å±•ï¼‰
* å‘å¸ƒ ContextPreparedEvent å’Œ ContextLoadedEvent

#### 2.3 åˆ·æ–°ä¸Šä¸‹æ–‡ï¼ˆ`context.refresh()`ï¼‰

è¿™æ˜¯ Spring çš„æ ¸å¿ƒï¼Œä¸‹é¢ä¼šåœ¨ç¬¬äºŒéƒ¨åˆ†è¯¦ç»†å±•å¼€ã€‚

---

### âœ… 3. åº”ç”¨å¯åŠ¨å®Œæˆï¼ˆ`afterRefresh()`ï¼‰

* æ‰§è¡Œ `CommandLineRunner`ã€`ApplicationRunner` ç­‰å›è°ƒ
* å‘å¸ƒ ApplicationStartedEventã€ApplicationReadyEvent

---

## äºŒã€æ¡†æ¶å†…éƒ¨è§†è§’ï¼ˆé‡ç‚¹ï¼š`context.refresh()`ï¼‰

è¿™æ˜¯ Spring IoC çš„å¯åŠ¨æ ¸å¿ƒæ–¹æ³•ã€‚ä»¥ `AbstractApplicationContext#refresh()` ä¸ºæ ¸å¿ƒæµç¨‹ï¼š

---

### ğŸŒ± 1. å‡†å¤‡ä¸Šä¸‹æ–‡ç¯å¢ƒ

```java
prepareRefresh();
```

* è®¾ç½®å¯åŠ¨æ—¶é—´ã€æ´»åŠ¨æ ‡å¿—ç­‰åŸºç¡€å±æ€§
* åˆå§‹åŒ– PropertySourcesã€æ ¡éªŒé…ç½®ç¯å¢ƒ

---

### ğŸ—ï¸ 2. è·å–æˆ–åˆ›å»º BeanFactory

```java
ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();
```

* åˆ›å»ºå¹¶åŠ è½½ BeanDefinitionï¼ˆä»é…ç½®ç±»ã€XMLã€ç»„ä»¶æ‰«æä¸­è¯»å–ï¼‰

---

### ğŸ§© 3. å‡†å¤‡ BeanFactoryï¼ˆå¢å¼ºï¼‰

```java
prepareBeanFactory(beanFactory);
```

* è®¾ç½®ç±»åŠ è½½å™¨ã€æ·»åŠ  Spring å†…éƒ¨å·¥å…· Beanï¼ˆæ¯”å¦‚ environmentã€resourceLoaderï¼‰
* æ³¨å†Œå„ç§ BeanPostProcessorã€Autowired è§£æå™¨ç­‰

---

### ğŸ§¼ 4. åå¤„ç† BeanFactoryï¼ˆå¯æ‰©å±•ï¼‰

```java
postProcessBeanFactory(beanFactory);
```

* ç•™ç»™å­ç±»ï¼ˆå¦‚ `AnnotationConfigApplicationContext`ï¼‰æ‰©å±•ï¼Œæ³¨å†Œæ³¨è§£é…ç½®ç±»ç­‰

---

### ğŸ“‹ 5. è°ƒç”¨ BeanFactoryPostProcessor

```java
invokeBeanFactoryPostProcessors(beanFactory);
```

* æ¯”å¦‚ `ConfigurationClassPostProcessor` è§£æ `@Configuration` ç±»ï¼Œæ‰«æ `@Component` ç­‰

---

### ğŸ”Œ 6. æ³¨å†Œ BeanPostProcessor

```java
registerBeanPostProcessors(beanFactory);
```

* æ³¨å†Œç”¨äºå¢å¼º Bean çš„é€»è¾‘ï¼ˆæ¯”å¦‚ AOPã€@Autowiredã€@Value ç­‰ï¼‰

---

### ğŸŒ 7. åˆå§‹åŒ–å›½é™…åŒ–èµ„æºã€ç›‘å¬å™¨ç­‰

```java
initMessageSource();
initApplicationEventMulticaster();
```

---

### ğŸ“š 8. åˆå§‹åŒ–ç‰¹æ®Š Bean

```java
onRefresh(); // å¦‚ Web ç¯å¢ƒä¼šå¯åŠ¨åµŒå…¥å¼ Tomcat
```

---

### ğŸ§± 9. å®ä¾‹åŒ–å‰©ä¸‹çš„å•ä¾‹ Bean

```java
finishBeanFactoryInitialization(beanFactory);
```

* åˆå§‹åŒ–æ‰€æœ‰éæ‡’åŠ è½½å•ä¾‹ Bean
* å®ç°ä¾èµ–æ³¨å…¥ã€AOP å¢å¼ºç­‰åŠŸèƒ½

---

### âœ… 10. å‘å¸ƒå®Œæˆäº‹ä»¶

```java
finishRefresh();
```

* å‘å¸ƒ `ContextRefreshedEvent`
* æ¸…é™¤ç¼“å­˜ï¼Œå¯åŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨ï¼ˆæ¯”å¦‚ Servletï¼‰

---

## ä¸‰ã€å°ç»“æµç¨‹å›¾ï¼ˆç²¾ç®€ç‰ˆï¼‰

```
main() -> SpringApplication.run()
           â”œâ”€â”€ åˆ›å»º SpringApplication
           â”œâ”€â”€ run()
           â”‚    â”œâ”€â”€ åˆ›å»º Environment
           â”‚    â”œâ”€â”€ åˆ›å»º ApplicationContext
           â”‚    â”œâ”€â”€ æ³¨å†Œä¸»é…ç½®ç±»
           â”‚    â”œâ”€â”€ context.refresh()
           â”‚    â”‚    â”œâ”€â”€ åˆ›å»º/åŠ è½½ BeanDefinition
           â”‚    â”‚    â”œâ”€â”€ åˆå§‹åŒ– BeanFactory
           â”‚    â”‚    â”œâ”€â”€ è°ƒç”¨åç½®å¤„ç†å™¨
           â”‚    â”‚    â”œâ”€â”€ å®ä¾‹åŒ–å•ä¾‹ Bean
           â”‚    â”‚    â””â”€â”€ å‘å¸ƒ ContextRefreshedEvent
           â”‚    â”œâ”€â”€ æ‰§è¡Œ Runner
           â”‚    â””â”€â”€ å‘å¸ƒ ApplicationReadyEvent
```

---

å½“ç„¶å¯ä»¥ï¼ŒSpring å¯åŠ¨è¿‡ç¨‹å¯ä»¥ç®€åŒ–ä¸º **5 ä¸ªå…³é”®æ­¥éª¤**ï¼Œæ¯ä¸€æ­¥éƒ½æ‰¿æ‹…ç‰¹å®šä½œç”¨ï¼Œä¸‹é¢æ˜¯ç®€æ´æ˜äº†çš„ç‰ˆæœ¬ï¼š

---

## ğŸŒŸ Spring å¯åŠ¨ç®€è¦æµç¨‹ï¼ˆé€‚ç”¨äº Spring Bootï¼‰

### **æ­¥éª¤ä¸€ï¼šå¯åŠ¨å…¥å£ï¼ˆmain æ–¹æ³•ï¼‰**

```java
SpringApplication.run(MyApplication.class, args);
```

**ä½œç”¨ï¼š**

* æ„å»ºå¹¶å¯åŠ¨ Spring åº”ç”¨
* åˆå§‹åŒ– `SpringApplication` å¯¹è±¡

---

### **æ­¥éª¤äºŒï¼šç¯å¢ƒå‡†å¤‡**

**å…³é”®æ–¹æ³•ï¼š** `prepareEnvironment()`

**ä½œç”¨ï¼š**

* åŠ è½½é…ç½®æ–‡ä»¶ï¼ˆå¦‚ `application.yml`ï¼‰
* åˆ›å»ºå¹¶è®¾ç½® `Environment`ï¼ˆåŒ…å«ç«¯å£ã€é…ç½®ç­‰ï¼‰
* é€šçŸ¥ç›‘å¬å™¨ï¼š`ApplicationEnvironmentPreparedEvent`

---

### **æ­¥éª¤ä¸‰ï¼šåˆ›å»º ApplicationContext**

**å…³é”®æ–¹æ³•ï¼š** `createApplicationContext()`

**ä½œç”¨ï¼š**

* åˆ›å»º IOC å®¹å™¨ï¼ˆæ¯”å¦‚ `AnnotationConfigServletWebServerApplicationContext`ï¼‰
* åˆ¤æ–­æ˜¯ Web è¿˜æ˜¯é Web ç¯å¢ƒ
* æ³¨å†Œä¸»é…ç½®ç±»ï¼ˆ`@SpringBootApplication`ï¼‰

---

### **æ­¥éª¤å››ï¼šæ ¸å¿ƒåˆ·æ–°è¿‡ç¨‹ï¼ˆcontext.refresh()ï¼‰**

**ä½œç”¨ï¼š**
è¿™æ˜¯æ•´ä¸ª Spring å¯åŠ¨çš„æ ¸å¿ƒï¼Œä¸»è¦åŒ…æ‹¬ï¼š

1. åŠ è½½å¹¶æ³¨å†Œ BeanDefinitionï¼ˆç»„ä»¶æ‰«æã€é…ç½®ç±»ï¼‰
2. åˆå§‹åŒ– BeanFactory å’Œ BeanPostProcessor
3. å®ä¾‹åŒ–æ‰€æœ‰éæ‡’åŠ è½½çš„å•ä¾‹ Bean
4. å¤„ç† AOPã€@Autowiredã€@Value ç­‰åŠŸèƒ½
5. å‘å¸ƒ `ContextRefreshedEvent`

---

### **æ­¥éª¤äº”ï¼šåº”ç”¨å¯åŠ¨å®Œæˆ**

**ä½œç”¨ï¼š**

* æ‰§è¡Œ `CommandLineRunner` å’Œ `ApplicationRunner`
* å‘å¸ƒ `ApplicationReadyEvent`
* Spring åº”ç”¨å‡†å¤‡å¥½å¯¹å¤–æä¾›æœåŠ¡

---

## âœ… æ€»ç»“ä¸€å¥è¯ï¼š

> Spring å¯åŠ¨è¿‡ç¨‹æœ¬è´¨æ˜¯ï¼š
> **æ„å»ºç¯å¢ƒ â†’ åˆ›å»ºä¸Šä¸‹æ–‡ â†’ åŠ è½½ Bean â†’ åˆå§‹åŒ– Bean â†’ é€šçŸ¥å¯åŠ¨å®Œæˆ**

---

ç»§ç»­æé—®ï¼šhttps://chatgpt.com/share/68746c12-b740-8010-99f8-5e26f1f1577f


