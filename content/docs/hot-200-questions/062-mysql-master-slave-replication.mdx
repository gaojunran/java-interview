---
title: 062 	什么是 MySQL 的主从同步机制？它是如何实现的？
---

MySQL 的**主从同步机制**（Replication）是数据库高可用和读写分离架构的核心技术。它允许一个数据库服务器（**主库**，master）将数据的变更同步到一个或多个数据库服务器（**从库**，slave 或 replica），从而提升读性能、实现容灾备份、支持分布式部署等。

---

## 一、主从同步机制简介

* **主库（Master）**：处理写操作（INSERT/UPDATE/DELETE），并将这些变更记录到 **binary log（binlog）**。
* **从库（Slave）**：不直接写入数据，而是通过读取主库的 binlog 并应用其中的变更，保持数据同步。

---

## 二、主从同步的三个阶段

MySQL 的主从复制主要包括以下 **三步（线程）机制**：

### 1. 主库记录 binlog

* 当主库执行完一条写操作后，会将变更记录写入 **binary log（二进制日志）**。
* binlog 是一个 append-only 的日志文件，记录了所有会修改数据的语句或事件（取决于 binlog 格式）。

### 2. 从库通过 IO 线程拉取 binlog

* 从库启动一个 **IO 线程**，连接主库，发送 `COM_BINLOG_DUMP` 请求。
* 主库接收请求后，会从指定位置开始发送 binlog 内容。
* 从库将收到的 binlog 内容写入 **中继日志（relay log）** 文件。

### 3. 从库通过 SQL 线程重放 relay log

* 从库的 **SQL 线程** 读取 relay log，并按顺序执行这些语句，最终实现数据一致。

---

## 三、主从同步的线程模型

| 角色 | 线程名称               | 作用                        |
| -- | ------------------ | ------------------------- |
| 主库 | binlog dump thread | 向每个从库发送 binlog            |
| 从库 | IO thread          | 向主库请求 binlog，写入 relay log |
| 从库 | SQL thread         | 读取 relay log 并执行          |

从 MySQL 5.7 开始还引入了 **多线程复制（Multi-Threaded Replication）**，允许一个从库用多个 SQL 线程并发执行 relay log，提高性能。

---

## 四、binlog 的三种格式（重点）

1. **STATEMENT（默认旧格式）**

   * 记录原始 SQL 语句
   * 优点：体积小
   * 缺点：某些非确定性语句会导致主从不一致

2. **ROW**

   * 记录每一行变更前后的数据
   * 优点：一致性最好
   * 缺点：日志体积大

3. **MIXED**

   * 自动在 statement 和 row 之间切换

---

## 五、主从复制的延迟和一致性问题

* **复制延迟**：主库执行成功，但从库尚未执行完（如主写入快，从压力大）。
* **读写一致性问题**：如果应用读从库，可能读到旧数据（**解决方案：主从延迟监控或读写分离策略**）。
* **主从数据不一致**：网络故障、非确定性 SQL、手动修改等可能导致不一致。

---

## 六、主从搭建方式

可以通过如下方式手动搭建：

1. 主库开启 binlog（配置 `log-bin`）
2. 设置 server-id（主从不能相同）
3. 从库执行 `CHANGE MASTER TO` 指定主库地址、binlog 文件名和位置
4. 启动从库复制线程：`START SLAVE`

---

## 七、典型应用场景

* **读写分离**：主库写、从库读，提高并发能力
* **备份容灾**：主库故障时可手动切换到从库
* **多地部署**：主库在 A 地，从库在 B/C 地做就近读写

---


继续提问：https://chatgpt.com/share/68776d89-f948-8010-98e6-41e3bfd09fad
