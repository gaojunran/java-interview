---
title: 015 RabbitMQ æ€ä¹ˆå®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ
---

ä¸‹é¢æˆ‘ç”¨ **Spring Boot + RabbitMQ** çš„æ–¹å¼ï¼Œç»™ä½ è¯¦ç»†è®²è®²å¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—ã€‚

---

## æ–¹æ³•ä¸€ï¼šTTL + æ­»ä¿¡é˜Ÿåˆ—æ–¹å¼

è¿™æ˜¯æœ€å¸¸ç”¨ä¸”ä¸éœ€è¦æ’ä»¶çš„æ–¹å¼ã€‚

### ğŸ§  æ ¸å¿ƒåŸç†ï¼š

1. æ¶ˆæ¯å‘é€åˆ°ä¸€ä¸ª **â€œå»¶è¿Ÿé˜Ÿåˆ—â€ï¼ˆå…¶å®æ˜¯æ™®é€šé˜Ÿåˆ—ï¼‰** ï¼Œè®¾ç½® TTLï¼ˆTime-To-Liveï¼‰è¿‡æœŸæ—¶é—´ã€‚
2. æ¶ˆæ¯è¿‡æœŸåï¼Œä¼šè¢« RabbitMQ è‡ªåŠ¨æŠ•é€’åˆ°**æ­»ä¿¡äº¤æ¢æœºï¼ˆDead Letter Exchangeï¼‰**ã€‚
3. æ­»ä¿¡äº¤æ¢æœºç»‘å®šçš„å¦ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå°±æ˜¯ä½ çœŸæ­£çš„â€œå¤„ç†é˜Ÿåˆ—â€ã€‚
4. æ¶ˆæ¯å»¶è¿Ÿåˆ°æœŸåï¼Œæ‰ä¼šåˆ°è¾¾æ¶ˆè´¹è€…èƒ½æ¶ˆè´¹çš„é˜Ÿåˆ—ã€‚

---

### 1. æ·»åŠ ä¾èµ–ï¼ˆpom.xmlï¼‰

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

---

### 2. é…ç½®é˜Ÿåˆ—å’Œäº¤æ¢æœº

```java
@Configuration
public class RabbitConfig {

    public static final String DELAY_QUEUE = "delay.queue";
    public static final String DELAY_EXCHANGE = "delay.exchange";
    public static final String DELAY_ROUTING_KEY = "delay.routingkey";

    public static final String PROCESS_QUEUE = "process.queue";
    public static final String PROCESS_EXCHANGE = "process.exchange";
    public static final String PROCESS_ROUTING_KEY = "process.routingkey";

    // 2.1 å£°æ˜å»¶è¿Ÿé˜Ÿåˆ—ï¼Œè®¾ç½® TTL å’Œæ­»ä¿¡äº¤æ¢æœº
    @Bean
    public Queue delayQueue() {
        Map<String, Object> args = new HashMap<>();
        // æ¶ˆæ¯è¿‡æœŸåè½¬å‘çš„äº¤æ¢æœº
        args.put("x-dead-letter-exchange", PROCESS_EXCHANGE);
        // è½¬å‘æ—¶ä½¿ç”¨çš„è·¯ç”±é”®
        args.put("x-dead-letter-routing-key", PROCESS_ROUTING_KEY);
        // è®¾ç½®é˜Ÿåˆ—ä¸­æ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ¯«ç§’ (å¯é€‰ï¼Œå•æ¡æ¶ˆæ¯ä¹Ÿå¯ä»¥è®¾ç½®TTLè¦†ç›–è¿™é‡Œ)
        args.put("x-message-ttl", 60000); // 60ç§’
        return new Queue(DELAY_QUEUE, true, false, false, args);
    }

    // 2.2 å£°æ˜çœŸå®å¤„ç†é˜Ÿåˆ—
    @Bean
    public Queue processQueue() {
        return new Queue(PROCESS_QUEUE);
    }

    // 2.3 äº¤æ¢æœºå£°æ˜
    @Bean
    public DirectExchange delayExchange() {
        return new DirectExchange(DELAY_EXCHANGE);
    }

    @Bean
    public DirectExchange processExchange() {
        return new DirectExchange(PROCESS_EXCHANGE);
    }

    // 2.4 é˜Ÿåˆ—ç»‘å®šäº¤æ¢æœº
    @Bean
    public Binding delayBinding() {
        return BindingBuilder.bind(delayQueue()).to(delayExchange()).with(DELAY_ROUTING_KEY);
    }

    @Bean
    public Binding processBinding() {
        return BindingBuilder.bind(processQueue()).to(processExchange()).with(PROCESS_ROUTING_KEY);
    }
}
```

---

### 3. å‘é€æ¶ˆæ¯ï¼ˆå»¶è¿Ÿæ¶ˆæ¯ï¼‰

* è¿™é‡Œæ¶ˆæ¯å‘åˆ° `delay.exchange`ï¼Œè·¯ç”±åˆ° `delay.queue`ã€‚
* æ¶ˆæ¯åœ¨ `delay.queue` é˜Ÿåˆ—ä¸­è¿‡æœŸåï¼Œä¼šè¢«è‡ªåŠ¨è½¬å‘åˆ° `process.exchange`ï¼Œå¹¶è·¯ç”±åˆ° `process.queue`ã€‚

```java
@Service
public class DelaySender {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    public void sendDelayMsg(String msg) {
        // å‘é€æ¶ˆæ¯ï¼Œé»˜è®¤èµ° delay.exchange + delay.routingkey
        rabbitTemplate.convertAndSend(
            RabbitConfig.DELAY_EXCHANGE,
            RabbitConfig.DELAY_ROUTING_KEY,
            msg,
            message -> {
                // è¿™é‡Œå¯ä»¥å•ç‹¬è®¾ç½®æ¯æ¡æ¶ˆæ¯çš„TTLï¼ˆè¦†ç›–é˜Ÿåˆ—çš„TTLï¼‰
                message.getMessageProperties().setExpiration("30000"); // 30ç§’å»¶è¿Ÿ
                return message;
            });
    }
}
```

---

### 4. æ¶ˆè´¹æ¶ˆæ¯

```java
@Component
public class ProcessConsumer {

    @RabbitListener(queues = RabbitConfig.PROCESS_QUEUE)
    public void receive(String msg) {
        System.out.println("æ”¶åˆ°å»¶è¿Ÿæ¶ˆæ¯: " + msg);
        // è¿™é‡Œå¤„ç†ä¸šåŠ¡é€»è¾‘
    }
}
```

---

## æ–¹æ³•äºŒï¼šä½¿ç”¨ RabbitMQ å»¶è¿Ÿæ’ä»¶ `x-delayed-message`

### ğŸ”§ åŸç†ï¼š

* åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰ç±»å‹ä¸º `x-delayed-message` çš„äº¤æ¢æœºã€‚
* å‘é€æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š header ä¸­çš„ `x-delay` æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚
* RabbitMQ å†…éƒ¨å¸®ä½ å»¶è¿ŸæŠ•é€’ï¼Œä¸éœ€è¦ä¸­é—´é˜Ÿåˆ—æˆ– DLXã€‚

---

### 1. å¯ç”¨æ’ä»¶ï¼ˆåœ¨RabbitMQæœåŠ¡å™¨æ‰§è¡Œï¼‰

```bash
rabbitmq-plugins enable rabbitmq_delayed_message_exchange
```

---

### 2. Spring Boot é…ç½®è‡ªå®šä¹‰äº¤æ¢æœº

```java
@Bean
public CustomExchange delayedExchange() {
    Map<String, Object> args = new HashMap<>();
    args.put("x-delayed-type", "direct");
    return new CustomExchange("delayed.exchange", "x-delayed-message", true, false, args);
}

@Bean
public Queue delayedQueue() {
    return new Queue("delayed.queue");
}

@Bean
public Binding delayedBinding() {
    return BindingBuilder.bind(delayedQueue()).to(delayedExchange()).with("delayed.routingkey").noargs();
}
```

---

### 3. å‘é€å¸¦å»¶è¿Ÿçš„æ¶ˆæ¯

```java
@Service
public class DelayedMessageSender {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    public void sendDelayedMessage(String message, int delayTimeMillis) {
        rabbitTemplate.convertAndSend(
            "delayed.exchange",
            "delayed.routingkey",
            message,
            msg -> {
                msg.getMessageProperties().setHeader("x-delay", delayTimeMillis);
                return msg;
            }
        );
    }
}
```

---

### 4. æ¶ˆè´¹è€…ç›‘å¬é˜Ÿåˆ—

```java
@Component
public class DelayedMessageConsumer {

    @RabbitListener(queues = "delayed.queue")
    public void receive(String msg) {
        System.out.println("æ”¶åˆ°æ’ä»¶å»¶è¿Ÿæ¶ˆæ¯: " + msg);
        // ä¸šåŠ¡å¤„ç†
    }
}
```

---

# æ€»ç»“

| æ–¹æ¡ˆ                       | ä¼˜ç‚¹                 | ç¼ºç‚¹               |
| ------------------------ | ------------------ | ---------------- |
| TTL + DLX                | ä¸ä¾èµ–æ’ä»¶ï¼Œç®€å•ï¼Œæ™®éä½¿ç”¨      | å»¶è¿Ÿæ—¶é—´é˜Ÿåˆ—çº§åˆ«ï¼Œå•æ¡æ¶ˆæ¯ä¸çµæ´» |
| å»¶è¿Ÿæ’ä»¶ `x-delayed-message` | ç²¾ç¡®æ§åˆ¶æ¯æ¡æ¶ˆæ¯å»¶è¿Ÿæ—¶é—´ï¼ŒAPIç®€å• | éœ€è¦å®‰è£…æ’ä»¶ï¼Œè¿ç»´æˆæœ¬ç¨é«˜    |


---


ç»§ç»­æé—®ï¼šhttps://chatgpt.com/share/686d3687-0d70-8010-bac5-e91d2c7bcf57
