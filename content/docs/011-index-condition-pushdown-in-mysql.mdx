---
title: 011 	MySQL 的索引下推是什么？
---

MySQL 的 **索引下推（Index Condition Pushdown, ICP）** 是一种 **查询优化技术**，主要用于提升含有 **WHERE 子句** 的查询在使用 **二级索引（非聚簇索引）** 时的执行效率。

---

## 一、索引下推的基本概念

在默认情况下，当 MySQL 使用辅助索引进行查询时，**只用索引判断部分过滤条件**，但无法完全确定某条记录是否符合条件，因此还要访问回表查找完整数据再判断。这就带来了额外的 I/O 成本。

而 **索引下推** 则是在 **扫描索引阶段就提前使用 WHERE 子句中的条件** 来过滤掉不必要的记录，**减少回表次数，从而提升性能**。

---

## 二、使用场景

* 使用了 **辅助索引**（非主键索引/聚簇索引）；
* 查询中带有 **WHERE 子句**；
* WHERE 子句中有部分条件可以通过索引字段来判断。
* **有覆盖索引的情况下，就不需要回表，ICP 也就不会生效**。

---

## 三、执行流程对比（有 vs 无 ICP）

假设我们有如下表结构：

```sql
CREATE TABLE users (
    id INT PRIMARY KEY,
    name VARCHAR(100),
    age INT,
    INDEX idx_name_age (name, age)
);
```

查询语句如下：

```sql
SELECT * FROM users WHERE name = 'Alice' AND age = 30;
```

### 不使用索引下推（ICP关闭）：

1. 使用 `idx_name_age` 索引定位所有 `name = 'Alice'` 的索引条目；
2. 每条记录回表读取完整行；
3. 在 Server 层（ SQL 层）判断 `age = 30`；
4. 如果不满足条件，丢弃。

➡️ 缺点：**回表次数多**，即使最终不符合条件也读了数据页。

---

### 使用索引下推（ICP开启）：

1. 使用 `idx_name_age` 索引定位 `name = 'Alice'`；
2. **在索引层判断 `age = 30`**；
3. 满足条件的才回表取全行；
4. 返回结果。

➡️ 优点：**尽可能在索引层完成过滤，减少回表操作，提升效率。**

---

## 四、是否启用 ICP？

* MySQL 5.6 及以上默认启用索引下推；
* 可通过 `EXPLAIN` 语句查看是否启用了 ICP：

```sql
EXPLAIN SELECT * FROM users WHERE name = 'Alice' AND age = 30;
```

看 `Extra` 字段是否包含：

```
Using index condition
```

如果有这行，说明启用了索引下推。

---

## 五、ICP 的局限性

* 只适用于 **二级索引**；
* 对某些复杂表达式、函数（如 `WHERE age + 1 = 31`）可能无法下推；
* 对于主键索引（聚簇索引）或覆盖索引（`Using index`）不生效（因为不需要回表）。

---

## 六、总结

| 特性   | 有索引下推（ICP）     | 无索引下推           |
| ---- | -------------- | --------------- |
| 过滤时机 | 索引扫描时          | 回表后             |
| 回表次数 | 更少             | 更多              |
| 适用场景 | 二级索引 + WHERE   | 默认行为            |
| 开启方式 | MySQL 5.6+默认开启 | 可用 `EXPLAIN` 查看 |

---

继续提问：https://chatgpt.com/share/686cea38-2838-8010-97de-492275c58bf8
