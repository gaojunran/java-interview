---
title: 050 	Redis 集群的实现原理是什么？
---

Redis 集群（Redis Cluster）是一种**分布式的高可用存储架构**，用于实现数据在多个 Redis 节点之间的自动分片与故障转移。下面我会从以下几个方面详细讲解其实现原理：

---

## 一、核心目标

Redis 集群的主要目标是：

* **分布式存储**：支持海量数据分布在多个节点上。
* **高可用**：支持节点自动故障转移和主从复制。
* **去中心化**：不依赖单点调度，集群内部通过 Gossip 协议通信。

---

## 二、数据分片机制（分布式存储）

Redis Cluster 将数据划分为 **16384 个哈希槽（hash slots）**：

### 1. 哈希槽原理

* 对每个 key 计算 CRC16 值，再对 16384 取模。

  ```shell
  hash_slot = CRC16(key) % 16384
  ```
* 每个 Redis 节点负责一部分哈希槽，比如：

  * 节点 A：0 - 5460
  * 节点 B：5461 - 10922
  * 节点 C：10923 - 16383

### 2. 迁移与重分片

当添加/删除节点时，Redis 支持哈希槽的迁移，从而实现 **动态扩容/缩容**。

---

## 三、集群节点通信协议

Redis Cluster 节点之间使用 **Gossip 协议** 互相通信和发现故障。

### 1. 节点类型

* **主节点（Master）**：负责数据读写，维护哈希槽。
* **从节点（Slave）**：作为主节点备份，主挂时自动提升为主。

### 2. 通信机制

Redis Cluster 使用两种端口通信：

* **主服务端口**：默认 6379
* **集群总线端口**：默认 端口+10000（如 16379），用于节点之间交换 Gossip 数据和心跳。

### 3. Gossip 协议内容

节点周期性向其它节点发送 `PING`，接收 `PONG`，其中包含：

* 节点 ID、角色、状态（up/down）、槽位分布等

---

## 四、请求路由机制

客户端请求数据时，会基于 key 算出哈希槽，然后访问对应的主节点。

### 1. 三种访问情况

* **命中节点**：直接访问目标主节点。
* **访问错误节点**：节点返回 `MOVED` 指令，告诉客户端去正确的节点。
* **临时迁移中**：返回 `ASK`，客户端临时访问迁移目标节点。

### 2. 客户端缓存槽位映射

很多 Redis 客户端（如 Jedis）会缓存槽位到节点的映射表，提升路由效率。

---

## 五、高可用与故障转移

Redis Cluster 能在主节点宕机时自动进行主从切换。

### 1. 故障检测

* 每个节点都会 ping 其他节点。
* 若超过 `cluster-node-timeout` 没有响应，就标记为 **疑似下线（PFAIL）**。
* 如果半数以上主节点都认为某主节点不可用，则变为 **确实下线（FAIL）**。

### 2. 故障恢复

* 选择该主节点的某个从节点自动提升为主节点（基于优先级、复制偏移量等）。

---

## 六、Redis Cluster 的限制

虽然 Redis Cluster 功能强大，但也存在一些限制：

| 限制项      | 描述                     |
| -------- | ---------------------- |
| 事务支持     | 仅支持单 key 事务            |
| 多 key 操作 | 多 key 操作必须 key 在同一哈希槽  |
| Lua 脚本   | 同样要求操作 key 属于同一槽       |
| 客户端支持    | 客户端需支持 MOVED 和 ASK 重定向 |

---

## 七、部署结构示意图

```
                +---------+       +---------+       +---------+
                | Node A  |<----->| Node B  |<----->| Node C  |
                | Master  |       | Master  |       | Master  |
                +----+----+       +----+----+       +----+----+
                     |                 |                 |
             +-------+--+       +-----+----+       +-----+----+
             | Slave A1 |       | Slave B1 |       | Slave C1 |
             +----------+       +----------+       +----------+
```

---

## 八、总结

| 机制   | 描述                       |
| ---- | ------------------------ |
| 数据分片 | 16384 哈希槽，平均分布到各节点       |
| 高可用  | 主从复制 + 故障检测 + 自动故障转移     |
| 节点通信 | Gossip 协议，心跳检测与状态传播      |
| 请求路由 | 客户端计算槽位，支持 MOVED/ASK 重定向 |
| 去中心化 | 没有集中调度节点，所有节点对等          |

---

继续提问：https://chatgpt.com/share/68746bcf-5b78-8010-8735-a29c1dcb532b
